<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>세넷 (Senet) · 보드게임</title>

    <script src="multiplayer-ui.js" defer></script>
    <script src="multiplayer-game.js" defer></script>
    <script>
      // 디버깅을 위한 전역 함수
      window.debugGameState = function () {
        const game = window.multiplayerGame;
        const ui = window.multiplayerUI;
        console.log("🎮 게임 상태 디버그:", {
          game: game
            ? {
                turn: game.turn,
                roll: game.roll,
                pieces: game.pieces,
                isMultiplayer: game.isMultiplayer,
                playerId: game.playerId,
              }
            : null,
          ui: ui
            ? {
                playerId: ui.playerId,
                playerName: ui.playerName,
                currentRoom: ui.currentRoom,
              }
            : null,
        });
      };
    </script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="app">
      <!-- 멀티플레이어 로비 화면 -->
      <div id="lobby" class="lobby-screen">
        <div class="lobby-content">
          <h1>세넷 (Senet) 멀티플레이어</h1>

          <!-- 플레이어 이름 설정 -->
          <div class="player-setup-panel card">
            <h3>플레이어 설정</h3>
            <div class="player-form">
              <div class="form-group">
                <label for="player-name">플레이어 이름:</label>
                <input
                  type="text"
                  id="player-name"
                  value="플레이어1"
                  placeholder="플레이어 이름"
                />
              </div>
              <button id="btn-connect" class="btn">
                🎮 멀티플레이어 게임 시작
              </button>
            </div>
            <div class="server-info">
              <span class="server-status">🟢 서버 연결됨</span>
              <span class="server-url">localhost:8080</span>
            </div>
          </div>

          <!-- 방 목록 및 참가 -->
          <div class="rooms-panel card" id="rooms-panel" style="display: none">
            <h3>게임방</h3>

            <!-- 방 필터링 옵션 -->
            <div class="room-filters">
              <div class="filter-group">
                <label for="filter-status">상태:</label>
                <select id="filter-status" class="filter-select">
                  <option value="all">모든 방</option>
                  <option value="waiting">대기중</option>
                  <option value="playing">게임중</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="filter-password">비밀번호:</label>
                <select id="filter-password" class="filter-select">
                  <option value="">모두</option>
                  <option value="false">공개</option>
                  <option value="true">비밀번호</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="filter-players">플레이어:</label>
                <select id="filter-players" class="filter-select">
                  <option value="">모두</option>
                  <option value="2">2인용</option>
                </select>
              </div>
              <button id="btn-apply-filters" class="btn ghost small">
                필터 적용
              </button>
            </div>

            <div class="rooms-list" id="rooms-list">
              <!-- 방 목록이 여기에 동적으로 추가됨 -->
            </div>
            <div class="room-actions">
              <button id="btn-create-room" class="btn">새 방 만들기</button>
              <button id="btn-refresh-rooms" class="btn ghost">새로고침</button>
            </div>
          </div>

          <!-- 로컬 게임 시작 -->
          <div class="local-game-panel card">
            <h3>로컬 게임</h3>
            <p>혼자서 게임을 즐기거나 멀티플레이어 없이 플레이하세요.</p>
            <a
              href="../senet-single/index.html"
              id="btn-start-local"
              class="btn"
              >로컬 게임 시작</a
            >
          </div>
        </div>
      </div>

      <!-- 대기 화면 (방 참가/생성 후) -->
      <div id="waiting-screen" class="waiting-screen" style="display: none">
        <div class="waiting-content">
          <header class="waiting-header">
            <h2>🎮 게임 대기실</h2>
            <div id="room-info-display">
              <!-- 방 정보가 JavaScript로 동적으로 표시됨 -->
            </div>
          </header>

          <div class="waiting-main">
            <!-- 플레이어 목록 -->
            <div class="players-panel card">
              <h3>👥 플레이어 목록</h3>
              <div class="players-list" id="players-list">
                <!-- 플레이어 목록이 JavaScript로 동적으로 표시됨 -->
              </div>
            </div>

            <!-- 게임 준비 상태 -->
            <div class="game-ready-panel card">
              <h3>🎯 게임 준비</h3>
              <div class="ready-status">
                <p>모든 플레이어가 준비되면 게임이 시작됩니다.</p>
                <!-- 준비 버튼 -->
                <div class="ready-actions">
                  <button id="btn-ready" class="ready-btn" disabled>
                    준비
                  </button>
                </div>
              </div>
            </div>

            <!-- 액션 버튼들 -->
            <div class="waiting-actions">
              <button id="btn-start-game" class="btn" disabled>
                게임 시작
              </button>
              <button id="btn-leave-room" class="btn ghost">방 나가기</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 기존 게임 화면 (초기에는 숨김) -->
      <div id="game-screen" class="game-screen" style="display: none">
        <header>
          <div class="row">
            <h1>세넷 (Senet)</h1>
            <div class="pill">
              <span class="turn-dot" id="turn-dot"></span
              ><span id="turn-label"></span>
            </div>
          </div>
          <div class="row">
            <button id="btn-rules" class="btn ghost">규칙</button>
            <button id="btn-reset" class="btn ghost">새 게임</button>
            <button id="btn-back-to-lobby" class="btn ghost">
              로비로 돌아가기
            </button>
          </div>
        </header>

        <!-- 멀티플레이어 상태 표시 -->
        <div
          class="multiplayer-status card"
          id="multiplayer-status"
          style="display: none"
        >
          <div class="status-row">
            <div class="connection-info">
              <span class="status-dot" id="game-connection-dot"></span>
              <span id="game-connection-text">연결됨</span>
            </div>
            <div class="room-info">
              <span>방: </span>
              <span id="current-room-name">-</span>
            </div>
          </div>
          <div class="players-info">
            <div class="player-item current" id="current-player">
              <span class="player-name">나</span>
              <span class="player-status">현재 턴</span>
            </div>
            <div class="player-item opponent" id="opponent-player">
              <span class="player-name">상대방</span>
              <span class="player-status">대기 중</span>
            </div>
          </div>
        </div>

        <div class="wrap">
          <section class="card">
            <div class="row" style="align-items: center; gap: 12px">
              <button id="roll" class="btn">막대기 던지기 (R)</button>
              <div class="sticks" aria-live="polite" aria-atomic="true">
                <div class="stick" id="s0"><div class="face">●</div></div>
                <div class="stick" id="s1"><div class="face">●</div></div>
                <div class="stick" id="s2"><div class="face">●</div></div>
                <div class="stick" id="s3"><div class="face">●</div></div>
              </div>
              <div class="result" id="result">–</div>
            </div>
            <div id="status"></div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 6px">
              특수칸: <b>15</b>·<b>26</b> 안전 / <b>27</b> 물(15→26 귀환) /
              <b>30</b> 탈출
            </div>
          </section>

          <section class="board card">
            <div
              id="board"
              class="grid"
              role="grid"
              aria-label="세넷 보드"
            ></div>
          </section>
        </div>
      </div>
    </div>

    <dialog id="rules">
      <div class="modal">
        <header><h2>세넷 규칙 요약</h2></header>
        <div class="body">
          <ol>
            <li>
              막대기 4개: 앞면 수(1~4)만큼 이동, 모두 뒷면이면 5칸. 4·5는
              추가턴(단, 물칸 착지/패스 시 추가턴 없음).
            </li>
            <li>
              같은 편 말 위에는 착지 불가. 상대 말 한 개면 자리 교환, 단
              <b>안전칸(15,26)</b> 또는 상대가 연속(보호) 중이면 교환 불가.
            </li>
            <li>
              상대 연속 ≥2는 쌍둥이 벽: 그 칸을
              <b>지나갈 수도, 착지할 수도 없음</b>.
            </li>
            <li>27(물): 착지 시 즉시 15(없으면 26)으로 귀환하고 턴 종료.</li>
            <li>30(탈출): 정확히 도착해야 탈출. 모든 말 탈출 시 승리.</li>
          </ol>
        </div>
        <footer>
          <button
            class="btn ghost"
            onclick="document.getElementById('rules').close()"
          >
            닫기
          </button>
        </footer>
      </div>
    </dialog>

    <!-- 방 생성 다이얼로그 -->
    <dialog id="create-room">
      <div class="modal">
        <header><h2>새 게임방 만들기</h2></header>
        <div class="body">
          <div class="form-group">
            <label for="room-name">방 이름:</label>
            <input
              type="text"
              id="room-name"
              placeholder="방 이름을 입력하세요"
            />
          </div>
          <div class="form-group">
            <label for="room-password">비밀번호 (선택사항):</label>
            <input
              type="password"
              id="room-password"
              placeholder="비밀번호를 입력하세요"
            />
          </div>
        </div>
        <footer>
          <button
            class="btn ghost"
            onclick="document.getElementById('create-room').close()"
          >
            취소
          </button>
          <button id="btn-confirm-create-room" class="btn">방 만들기</button>
        </footer>
      </div>
    </dialog>

    <script>
      // 전역 변수로 설정
      window.multiplayerUI = null;
      window.multiplayerGame = null;

      // DOM 로드 완료 후 초기화
      document.addEventListener("DOMContentLoaded", function () {
        console.log("🚀 DOM 로드 완료, 멀티플레이어 초기화 시작");

        // 약간의 지연을 주어 스크립트 로딩 완료 대기
        setTimeout(() => {
          // MultiplayerUI 초기화
          if (typeof MultiplayerUI !== "undefined") {
            window.multiplayerUI = new MultiplayerUI();
            console.log("✅ MultiplayerUI 초기화 완료");
            
            // MultiplayerSenetGame 초기화 (UI 초기화 후)
            if (typeof MultiplayerSenetGame !== "undefined") {
              window.multiplayerGame = new MultiplayerSenetGame();
              console.log("✅ MultiplayerSenetGame 초기화 완료");
              
              // WebSocket 연결 설정
              if (window.multiplayerGame && window.multiplayerUI) {
                // 잠시 후 연결 설정 (UI의 WebSocket이 준비될 때까지 대기)
                setTimeout(() => {
                  window.multiplayerGame.connectToServer();
                }, 1000);
              }
            } else {
              console.error("❌ MultiplayerSenetGame 클래스를 찾을 수 없음");
            }
          } else {
            console.error("❌ MultiplayerUI 클래스를 찾을 수 없음");
          }

          console.log("🎮 멀티플레이어 시스템 초기화 완료");
        }, 100);
      });
    </script>
  </body>
</html>
